name: Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  COVERAGE_THRESHOLD: '80'

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
    - name: Setup Go environment
      uses: ./.github/actions/setup-go
      with:
        fetch-depth: '0'

    - name: Install goimports
      run: go install golang.org/x/tools/cmd/goimports@latest

    - name: Check formatting and imports
      run: |
        GOBIN=$(go env GOPATH)/bin
        if [ -n "$($GOBIN/goimports -l -local github.com/mstephenholl/go-solar .)" ]; then
          echo "Code is not formatted or imports need organization. Run 'make fmt' to fix."
          $GOBIN/goimports -d -local github.com/mstephenholl/go-solar .
          exit 1
        fi
        echo "Code is properly formatted"

    - name: Run go vet
      run: go vet ./...

    - name: Run tests with coverage
      run: |
        go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
        go tool cover -func=coverage.out -o coverage.txt

    - name: Calculate coverage
      id: coverage
      run: |
        COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
        echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
        echo "Coverage: $COVERAGE%"

    - name: Generate coverage badge color
      id: badge
      run: |
        COVERAGE=${{ steps.coverage.outputs.coverage }}
        if (( $(echo "$COVERAGE >= 90" | bc -l) )); then
          echo "color=brightgreen" >> $GITHUB_OUTPUT
        elif (( $(echo "$COVERAGE >= 80" | bc -l) )); then
          echo "color=green" >> $GITHUB_OUTPUT
        elif (( $(echo "$COVERAGE >= 70" | bc -l) )); then
          echo "color=yellow" >> $GITHUB_OUTPUT
        elif (( $(echo "$COVERAGE >= 60" | bc -l) )); then
          echo "color=orange" >> $GITHUB_OUTPUT
        else
          echo "color=red" >> $GITHUB_OUTPUT
        fi

    - name: Comment PR with coverage
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const upsert = require('./.github/scripts/upsert-comment.js');
          const coverage = '${{ steps.coverage.outputs.coverage }}';
          const color = '${{ steps.badge.outputs.color }}';
          const threshold = process.env.COVERAGE_THRESHOLD;
          const coverageDetails = require('fs').readFileSync('coverage.txt', 'utf8');

          const body = `## üìä Test Coverage Report

          ![Coverage](https://img.shields.io/badge/coverage-${coverage}%25-${color})

          <details>
          <summary>üìà Coverage Details</summary>

          \`\`\`
          ${coverageDetails}
          \`\`\`

          </details>

          ---
          *Coverage threshold: ${threshold}%*
          ${parseFloat(coverage) >= parseInt(threshold) ? '‚úÖ Coverage meets threshold!' : '‚ö†Ô∏è Coverage below threshold'}`;

          await upsert({ github, context, marker: 'Test Coverage Report', body });

    - name: Check coverage threshold
      run: |
        COVERAGE=${{ steps.coverage.outputs.coverage }}
        THRESHOLD=${{ env.COVERAGE_THRESHOLD }}
        if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
          echo "Coverage ($COVERAGE%) is below threshold ($THRESHOLD%)"
          echo "Please add more tests to improve coverage"
          exit 1
        fi
        echo "Coverage ($COVERAGE%) meets threshold ($THRESHOLD%)"

  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-latest

    steps:
    - name: Setup Go environment
      uses: ./.github/actions/setup-go

    - name: Run benchmarks
      run: |
        go test -bench=. -benchmem -run=^$ ./... | tee benchmark.txt

    - name: Comment PR with benchmarks
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const upsert = require('./.github/scripts/upsert-comment.js');
          const benchmark = require('fs').readFileSync('benchmark.txt', 'utf8');

          const body = `## ‚ö° Benchmark Results

          <details>
          <summary>View benchmark results</summary>

          \`\`\`
          ${benchmark}
          \`\`\`

          </details>`;

          await upsert({ github, context, marker: 'Benchmark Results', body });
