name: Release

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [ master ]
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type (auto, major, minor, patch)'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - major
          - minor
          - patch

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    name: Create Automated Release
    runs-on: ubuntu-latest
    # Only run if CI workflow completed successfully
    if: |
      github.event.workflow_run.conclusion == 'success' ||
      github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Go environment
      uses: ./.github/actions/setup-go

    - name: Get latest semver tag
      id: latest_tag
      run: |
        # Find the latest semver tag, filtering out CalVer tags (major >= 100)
        LATEST=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-version:refname \
          | awk -F'[v.]' '$2 < 100 {print; exit}')
        if [ -z "$LATEST" ]; then
          echo "tag=" >> $GITHUB_OUTPUT
          echo "No semver tags found"
        else
          echo "tag=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest semver tag: $LATEST"
        fi

    - name: Determine bump type
      id: bump
      run: |
        MANUAL_BUMP="${{ github.event.inputs.bump || 'auto' }}"

        if [ "$MANUAL_BUMP" != "auto" ]; then
          echo "type=$MANUAL_BUMP" >> $GITHUB_OUTPUT
          echo "Bump type (manual override): $MANUAL_BUMP"
          exit 0
        fi

        PREV_TAG="${{ steps.latest_tag.outputs.tag }}"
        if [ -z "$PREV_TAG" ]; then
          echo "type=minor" >> $GITHUB_OUTPUT
          echo "No previous semver tag -- defaulting to minor (initial release)"
          exit 0
        fi

        # Parse conventional commits since last tag
        COMMITS=$(git log "${PREV_TAG}..HEAD" --pretty=format:"%s" --no-merges)

        if echo "$COMMITS" | grep -qE "(^feat!|^fix!|^refactor!|BREAKING CHANGE)"; then
          echo "type=major" >> $GITHUB_OUTPUT
          echo "Bump type: major (breaking change detected)"
        elif echo "$COMMITS" | grep -qE "^feat(\(.*\))?:"; then
          echo "type=minor" >> $GITHUB_OUTPUT
          echo "Bump type: minor (new feature detected)"
        else
          echo "type=patch" >> $GITHUB_OUTPUT
          echo "Bump type: patch (fixes/maintenance only)"
        fi

    - name: Calculate next version
      id: version
      run: |
        PREV_TAG="${{ steps.latest_tag.outputs.tag }}"
        BUMP="${{ steps.bump.outputs.type }}"

        if [ -z "$PREV_TAG" ]; then
          VERSION="1.0.0"
        else
          # Strip leading 'v'
          PREV=${PREV_TAG#v}
          MAJOR=$(echo "$PREV" | cut -d. -f1)
          MINOR=$(echo "$PREV" | cut -d. -f2)
          PATCH=$(echo "$PREV" | cut -d. -f3)

          case "$BUMP" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          VERSION="${MAJOR}.${MINOR}.${PATCH}"
        fi

        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Next version: v${VERSION}"

    - name: Check if tag exists
      id: check_tag
      run: |
        if git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Tag v${{ steps.version.outputs.version }} already exists, skipping release"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "Tag v${{ steps.version.outputs.version }} does not exist, will create release"
        fi

    - name: Get previous tag
      id: previous_tag
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        PREV_TAG="${{ steps.latest_tag.outputs.tag }}"
        if [ -z "$PREV_TAG" ]; then
          echo "previous_tag=" >> $GITHUB_OUTPUT
          echo "is_first_release=true" >> $GITHUB_OUTPUT
          echo "No previous tag found - this is the first semver release"
        else
          echo "previous_tag=${PREV_TAG}" >> $GITHUB_OUTPUT
          echo "is_first_release=false" >> $GITHUB_OUTPUT
          echo "Previous tag: ${PREV_TAG}"
        fi

    - name: Generate changelog
      id: changelog
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        VERSION="v${{ steps.version.outputs.version }}"
        PREV_TAG="${{ steps.previous_tag.outputs.previous_tag }}"
        REPO="github.com/mstephenholl/go-solar"

        if [ "${{ steps.previous_tag.outputs.is_first_release }}" = "true" ]; then
          COMMIT_RANGE=""
          echo "## Initial Release" > changelog.md
        else
          COMMIT_RANGE="${PREV_TAG}..HEAD"
          echo "## Changes since ${PREV_TAG}" > changelog.md
        fi
        echo "" >> changelog.md

        # Categorize commits by conventional commit prefix
        for category in \
          "feat:Features" \
          "fix:Bug Fixes" \
          "perf:Performance" \
          "refactor:Refactors" \
          "docs:Documentation" \
          "test:Tests" \
          "chore:Maintenance"; do
          PREFIX="${category%%:*}"
          LABEL="${category##*:}"
          MATCHES=$(git log ${COMMIT_RANGE} --pretty=format:"- %s (%h)" --no-merges \
            | grep -E "^- ${PREFIX}(\(.*\))?:" || true)
          if [ -n "$MATCHES" ]; then
            echo "### ${LABEL}" >> changelog.md
            echo "" >> changelog.md
            echo "$MATCHES" >> changelog.md
            echo "" >> changelog.md
          fi
        done

        # Uncategorized commits
        OTHER=$(git log ${COMMIT_RANGE} --pretty=format:"- %s (%h)" --no-merges \
          | grep -vE "^- (feat|fix|perf|refactor|docs|test|chore)(\(.*\))?:" || true)
        if [ -n "$OTHER" ]; then
          echo "### Other Changes" >> changelog.md
          echo "" >> changelog.md
          echo "$OTHER" >> changelog.md
          echo "" >> changelog.md
        fi

        cat >> changelog.md << EOF
        ---

        ### Installation

        \`\`\`bash
        go get ${REPO}@${VERSION}
        \`\`\`

        ### Documentation

        - [Package Documentation](https://pkg.go.dev/${REPO}@${VERSION})
        - [GitHub Repository](https://${REPO})
        EOF

        if [ -n "$PREV_TAG" ]; then
          echo "- [Full Changelog](https://${REPO}/compare/${PREV_TAG}...${VERSION})" >> changelog.md
        fi

        cat >> changelog.md << EOF

        ### Requirements

        - Go 1.24 or later
        EOF

        echo "Changelog generated successfully"
        cat changelog.md

    - name: Create Git tag
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "v${{ steps.version.outputs.version }}" -m "Release v${{ steps.version.outputs.version }}"
        git push origin "v${{ steps.version.outputs.version }}"
        echo "Tag v${{ steps.version.outputs.version }} created and pushed"

    - name: Create GitHub Release
      if: steps.check_tag.outputs.exists == 'false'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: Release v${{ steps.version.outputs.version }}
        body_path: changelog.md
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Summary
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        echo "## Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Release Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** v${{ steps.version.outputs.version }} (Semver)" >> $GITHUB_STEP_SUMMARY
        echo "- **Bump type:** ${{ steps.bump.outputs.type }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Previous Tag:** ${{ steps.previous_tag.outputs.previous_tag || 'None (first release)' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Installation" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "go get github.com/mstephenholl/go-solar@v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Links" >> $GITHUB_STEP_SUMMARY
        echo "- [View Release](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
        echo "- [Documentation](https://pkg.go.dev/github.com/mstephenholl/go-solar@v${{ steps.version.outputs.version }})" >> $GITHUB_STEP_SUMMARY

    - name: Skip message
      if: steps.check_tag.outputs.exists == 'true'
      run: |
        echo "## Release Skipped" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Tag v${{ steps.version.outputs.version }} already exists for this commit." >> $GITHUB_STEP_SUMMARY
        echo "No new release was created." >> $GITHUB_STEP_SUMMARY
